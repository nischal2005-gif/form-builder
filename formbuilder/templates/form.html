<!DOCTYPE html>
<html>
<head>
    <title>Edit Form - {{ form_obj.title|default:"New Form" }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .form-container {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .field-group {
            background-color: #f8f9fa;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }
        .required-field::after {
            content: " *";
            color: red;
        }
        .regex-container {
            background-color: #f0f8ff;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="form-container">
        <h1>{{ form_obj.title|default:"New Form" }}</h1>
        <p class="text-muted">Configure your form fields below. Email notifications are managed separately.</p>

        <form method="POST">
            {% csrf_token %}
            
            <!-- Basic Form Info -->
            <div class="mb-3">
                <label for="title" class="form-label required-field">Form Title</label>
                <input type="text" class="form-control" id="title" name="title" value="{{ form_obj.title }}" required>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="2">{{ form_obj.description }}</textarea>
            </div>

            <!-- Form Options -->
            <div class="mb-3 p-3 bg-light rounded">
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="recaptcha_enabled" name="recaptcha_enabled" 
                        {% if form_obj.recaptcha_enabled %}checked{% endif %}>
                    <label class="form-check-label" for="recaptcha_enabled">Enable reCAPTCHA</label>
                </div>

                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="email_confirmation_required" name="email_confirmation_required" 
                        {% if form_obj.email_confirmation_required %}checked{% endif %}>
                    <label class="form-check-label" for="email_confirmation_required">Require Email Confirmation</label>
                </div>
            </div>

            <!-- Confirmation Message (only shown if confirmation enabled) -->
          

            <!-- Form Fields Section -->
            <h3 class="mt-4">Form Fields</h3>
            <div id="field-container">
                {{ field_formset.management_form }}
                {% for form in field_formset %}
                    <div class="field-group">
                        {{ form.id }}
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label required-field">Label</label>
                                {{ form.label }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label required-field">Field Type</label>
                                {{ form.field_type }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Required</label>
                                <div class="form-check form-switch mt-2">
                                    {{ form.required }}
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Regex</label>
                                <div class="form-check form-switch mt-2">
                                    <input type="checkbox" name="form-{{ forloop.counter0 }}-regex_enabled" 
                                           class="form-check-input regex-toggle" 
                                           {% if form.regex_validation.value %}checked{% endif %}>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Delete</label>
                                <div class="form-check form-switch mt-2">
                                    {{ form.DELETE }}
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2" id="choicesContainer-{{ forloop.counter0 }}" 
                            style="display: {% if form.field_type.value in 'radio,checkbox' %}block{% else %}none{% endif %}">
                            <div class="col-md-12">
                                <label class="form-label">Options (comma separated)</label>
                                {{ form.choices }}
                            </div>
                        </div>
                        <div class="regex-container mt-2" id="regexContainer-{{ forloop.counter0 }}" 
                            style="display: {% if form.regex_validation.value %}block{% else %}none{% endif %}">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Regex Pattern</label>
                                    <input type="text" name="form-{{ forloop.counter0 }}-regex_validation" 
                                           class="form-control" 
                                           value="{{ form.regex_validation.value|default:'' }}"
                                           placeholder="^[a-zA-Z ]+$">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Error Message</label>
                                    <input type="text" name="form-{{ forloop.counter0 }}-regex_error_message" 
                                           class="form-control" 
                                           value="{{ form.regex_error_message.value|default:'Invalid format' }}"
                                           placeholder="Custom error message">
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'home' %}" class="btn btn-secondary">Cancel</a>
                <div>
                    <button type="button" class="btn btn-outline-primary" id="add-field-btn">+ Add Field</button>
                    <button type="submit" class="btn btn-primary">Save Form</button>
                </div>
            </div>

            {% if error %}
                <div class="alert alert-danger mt-3">{{ error }}</div>
            {% endif %}
        </form>
    </div>
</div>

<script>
    // Show/hide confirmation message based on checkbox
    document.getElementById('email_confirmation_required').addEventListener('change', function() {
        document.getElementById('confirmationMessageContainer').style.display = 
            this.checked ? 'block' : 'none';
    });

    // Add new field
    document.getElementById('add-field-btn').addEventListener('click', function() {
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const formCount = parseInt(totalForms.value);
        const container = document.getElementById('field-container');
        
        const newFieldHtml = `
        <div class="field-group">
            <div class="row">
                <div class="col-md-3">
                    <input type="text" name="form-${formCount}-label" class="form-control" required>
                </div>
                <div class="col-md-2">
                    <select name="form-${formCount}-field_type" class="form-control field-type-select">
                        <option value="text">Text</option>
                        <option value="email">Email</option>
                        <option value="textarea">Textarea</option>
                        <option value="number">Number</option>
                        <option value="date">Date</option>
                        <option value="radio">Radio</option>
                        <option value="checkbox">Checkbox</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="form-check form-switch mt-2">
                        <input type="checkbox" name="form-${formCount}-required" class="form-check-input" checked>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-check form-switch mt-2">
                        <input type="checkbox" name="form-${formCount}-regex_enabled" class="form-check-input regex-toggle">
                    </div>
                </div>
                <div class="col-md-2">
                    <input type="hidden" name="form-${formCount}-id">
                    <div class="form-check form-switch mt-2">
                        <input type="checkbox" name="form-${formCount}-DELETE" class="form-check-input">
                    </div>
                </div>
            </div>
            <div class="row mt-2" id="choicesContainer-${formCount}" style="display:none">
                <div class="col-md-12">
                    <input type="text" name="form-${formCount}-choices" class="form-control" placeholder="Option 1, Option 2, Option 3">
                </div>
            </div>
            <div class="regex-container mt-2" id="regexContainer-${formCount}" style="display:none">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" name="form-${formCount}-regex_validation" class="form-control" placeholder="^[a-zA-Z ]+$">
                    </div>
                    <div class="col-md-6">
                        <input type="text" name="form-${formCount}-regex_error_message" class="form-control" placeholder="Custom error message" value="Invalid format">
                    </div>
                </div>
            </div>
        </div>`;
        
        container.insertAdjacentHTML('beforeend', newFieldHtml);
        totalForms.value = formCount + 1;

        // Add event listener to new field type select
        document.querySelector(`select[name="form-${formCount}-field_type"]`).addEventListener('change', function() {
            const choicesContainer = document.getElementById(`choicesContainer-${formCount}`);
            choicesContainer.style.display = 
                (this.value === 'radio' || this.value === 'checkbox') ? 'block' : 'none';
        });

        // Add event listener to regex toggle
        document.querySelector(`input[name="form-${formCount}-regex_enabled"]`).addEventListener('change', function() {
            const regexContainer = document.getElementById(`regexContainer-${formCount}`);
            regexContainer.style.display = this.checked ? 'block' : 'none';
        });
    });

    // Show/hide choices based on field type (for existing fields)
    document.querySelectorAll('.field-type-select').forEach(select => {
        select.addEventListener('change', function() {
            const containerId = this.closest('.row').querySelector('[id^="choicesContainer"]').id;
            document.getElementById(containerId).style.display = 
                (this.value === 'radio' || this.value === 'checkbox') ? 'block' : 'none';
        });
    });

    // Toggle regex container visibility for existing fields
    document.querySelectorAll('.regex-toggle').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const containerId = this.closest('.row').parentNode.querySelector('[id^="regexContainer"]').id;
            document.getElementById(containerId).style.display = 
                this.checked ? 'block' : 'none';
        });
    });
</script>
</body>
</html>