<!DOCTYPE html>
<html>
<head>
  <title>Manage Notifications - {{ form.title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .dynamic-hint {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 0.25rem;
    }
    .badge-example {
      display: inline-block;
      background-color: #f8f9fa;
      color: #212529;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.8rem;
      margin: 0.2rem;
    }
  </style>
</head>
<body class="bg-light">
<div class="container py-5">
  <h1 class="mb-4">Manage Notifications for {{ form.title }}</h1>
  <a href="{% url 'home' %}" class="btn btn-secondary mb-3">Back to Forms</a>

  <!-- Add New Notification -->
  <div class="card mb-4 mt-4">
    <div class="card-header">
      <h3>Add New Notification</h3>
    </div>
    <div class="card-body">
      <form method="POST" action="{% url 'add_notification' form.id %}">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label">SMTP Configuration</label>
          <select class="form-select" name="smtp_config" required>
            <option value="">Select your SMTP configuration</option>
            {% for config in smtp_configs %}
              <option value="{{ config.id }}" {% if config.email == form_obj.sender_email %}selected{% endif %}>
                {{ config.email }} ({{ config.smtp_host }}:{{ config.smtp_port }})
                {% if config.is_verified %}
                  <span class="badge bg-success">Verified</span>
                {% else %}
                  <span class="badge bg-warning text-dark">Unverified</span>
                {% endif %}
              </option>
            {% empty %}
              <option value="" disabled>No SMTP configurations available</option>
            {% endfor %}
          </select>
          <div class="mt-2">
            <a href="{% url 'verify_smtp_sender' %}" class="btn btn-sm btn-outline-primary">
              Add New SMTP Configuration
            </a>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Receiver Email</label>
          <input type="text" class="form-control" name="receiver_email" required
                 placeholder="admin@example.com or [email_field_name]">
          <div class="dynamic-hint">
            <strong>Dynamic emails:</strong> Use square brackets to reference form fields<br>
            Example: <span class="badge-example">[email]</span> 
            <span class="badge-example">[contact_email]</span>
            <span class="badge-example">[work_email]</span>
            <br>Will use the first matching email-type field from the form
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Email Subject</label>
          <input type="text" class="form-control" name="subject" required
                 value="New submission for {{ form.title }}">
        </div>
        
        <div class="mb-3">
          <label class="form-label">Email Message</label>
          <textarea class="form-control" name="message" rows="5" required>You have received a new submission from [email].</textarea>
          <div class="dynamic-hint">
            <strong>Placeholders:</strong> Use square brackets to include form values<br>
            Example: <span class="badge-example">[name]</span> 
            <span class="badge-example">[phone]</span>
            <span class="badge-example">[message]</span>
          </div>
        </div>
        
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" name="dynamic_receiver" id="dynamic_receiver" checked>
          <label class="form-check-label" for="dynamic_receiver">
            Enable dynamic recipient detection
          </label>
        </div>
        
        <button type="submit" class="btn btn-primary">Add Notification</button>
      </form>
    </div>
  </div>

  <!-- Existing Notifications -->
  <h3 class="mt-4">Existing Notifications</h3>
  {% if notifications %}
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Receiver Email</th>
            <th>SMTP Sender</th>
            <th>Subject</th>
            <th>Type</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for notification in notifications %}
          <tr>
            <td>
              {{ notification.receiver_email }}
              {% if notification.dynamic_receiver %}
                <span class="badge bg-info">Dynamic</span>
              {% endif %}
            </td>
            <td>
              {% if notification.smtp_config %}
                {{ notification.smtp_config.email }}
              {% else %}
                <span class="text-muted">Default</span>
              {% endif %}
            </td>
            <td>{{ notification.subject|truncatechars:30 }}</td>
            <td>
              {% if notification.is_confirmation %}
                <span class="badge bg-success">Confirmation</span>
              {% else %}
                <span class="badge bg-primary">Notification</span>
              {% endif %}
            </td>
            <td>
              <form method="POST" action="{% url 'delete_notification' notification.id %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this notification?')">
                  Delete
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info">No notifications configured for this form.</div>
  {% endif %}
</div>
</body>
</html>